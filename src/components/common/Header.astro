---
import LangSwitch from './LangSwitch.astro';

interface Props {
  deSlug?: string;
  enSlug?: string;
}

const { deSlug = '', enSlug = '' } = Astro.props;

const currentLocale = Astro.currentLocale || 'de';
const isEn = currentLocale === 'en';

// The translation target is the slug of the OTHER language
const translationSlug = isEn ? deSlug : enSlug;

const navItems = [
  { de: 'Home', en: 'Home', dePath: '/', enPath: '/en' },
  { de: 'Studio', en: 'Studio', dePath: '/studio', enPath: '/en/studio' },
  { de: 'Kurse', en: 'Classes', dePath: '/kurse', enPath: '/en/classes' },
  { de: 'Preise', en: 'Pricing', dePath: '/preise', enPath: '/en/pricing' },
  { de: 'Events', en: 'Events', dePath: '/events', enPath: '/en/events' },
  { de: 'Wellness', en: 'Wellness', dePath: '/wellness', enPath: '/en/wellness' },
  { de: 'Team', en: 'Team', dePath: '/team', enPath: '/en/team' },
];

const pathname = new URL(Astro.request.url).pathname;
---

<header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-eos-subtle">
  <div class="max-w-7xl mx-auto w-full px-6 py-4 flex items-center justify-between gap-6">
    <!-- Logo + Brand (Left) -->
    <div class="flex items-center space-x-3">
      <a href={isEn ? '/en' : '/'} class="flex items-center space-x-3">
        <img src="/assets/web-app-manifest-512x512.png" alt="EOS CLUB Logo" class="h-8 w-auto" />
        <span class="font-serif font-bold text-lg tracking-wider text-eos-accent uppercase hidden lg:inline">EOS CLUB</span>
      </a>
    </div>

    <!-- Desktop Nav (Center - hidden on mobile) -->
    <nav id="desktop-nav" class="hidden lg:flex flex-1 items-center justify-center space-x-6 lg:space-x-8 relative">
      {navItems.map((item) => {
        const path = isEn ? item.enPath : item.dePath;
        const isActive = pathname === path;
        return (
          <a
            href={path}
            data-nav-link
            class={`text-sm font-bold uppercase tracking-widest text-eos-accent transition-colors duration-200 hover:text-eos-accent/70 relative py-2 ${isActive ? 'is-active' : ''}`}
          >
            {isEn ? item.en : item.de}
          </a>
        );
      })}
      <!-- Sliding Underline -->
      <div id="nav-underline" class="absolute bottom-0 h-0.5 bg-eos-accent opacity-0 pointer-events-none !m-0"></div>
    </nav>

    <!-- Right Section: Book Button, User Login, LangSwitch -->
    <!-- pointer-events-none on the wrapper prevents the transparent grid area from blocking -->
    <!-- overflow from the center nav (the "Team" link). Children restore pointer-events-auto. -->
    <div class="hidden lg:flex items-center justify-end space-x-4 pointer-events-none">
      <!-- Book Button -->
      <a
        href="https://backoffice.bsport.io/c/5082/home/"
        target="_blank"
        rel="noopener noreferrer"
        class="pointer-events-auto inline-flex items-center px-4 py-2 bg-eos-accent text-white text-sm font-bold uppercase tracking-widest rounded-lg transition-all duration-200 hover:bg-eos-accent/90 focus:outline-none focus:ring-2 focus:ring-eos-accent focus:ring-offset-2"
      >
        {isEn ? 'Book' : 'Buchen'}
      </a>

      <!-- User Login Icon -->
      <a
        href="https://backoffice.bsport.io/login?membership=5082"
        target="_blank"
        rel="noopener noreferrer"
        class="pointer-events-auto inline-flex items-center px-4 py-2 bg-eos-accent text-white text-sm font-bold uppercase tracking-widest rounded-lg transition-all duration-200 hover:bg-eos-accent/90 focus:outline-none focus:ring-2 focus:ring-eos-accent focus:ring-offset-2"
        aria-label={isEn ? 'User Login' : 'Benutzer Login'}
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span>{isEn ? 'Login' : 'Login'}</span>
      </a>

      <span class="pointer-events-auto"><LangSwitch translationSlug={translationSlug} /></span>
    </div>

    <!-- Mobile Hamburger (red icon, visible on mobile only) -->
    <button
      id="mobile-menu-button"
      class="lg:hidden p-2 text-eos-accent focus:outline-none transition-transform active:scale-95 justify-self-end"
      aria-label="Toggle Menu"
      aria-expanded="false"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>
</header>

  <!-- Mobile Overlay -->
<div
  id="mobile-overlay"
  class="fixed inset-0 bg-eos-contrast z-40 hidden opacity-0 transition-opacity duration-300"
></div>

<!-- Mobile Sidebar Panel -->
<aside
  id="mobile-sidebar"
  class="fixed left-0 top-0 h-screen w-full bg-white z-50 -translate-x-full sidebar-transition overflow-y-auto no-scrollbar flex flex-col pointer-events-none"
>
  <!-- Close Button -->
  <div class="flex items-center justify-between p-6 border-b border-eos-subtle">
    <a href={isEn ? '/en' : '/'} class="flex items-center space-x-3">
      <img src="/assets/web-app-manifest-512x512.png" alt="EOS CLUB Logo" class="h-8 w-auto" />
      <span class="font-serif font-bold text-lg tracking-wider text-eos-accent uppercase">EOS CLUB</span>
    </a>
    <button
      id="mobile-close-button"
      class="p-2 text-eos-accent focus:outline-none transition-transform active:scale-95"
      aria-label="Close Menu"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Mobile Nav Items -->
  <nav class="flex-1 px-6 py-8">
    <div class="flex flex-col space-y-2 items-center">
      {navItems.map((item) => {
        const path = isEn ? item.enPath : item.dePath;
        const isActive = pathname === path || (path !== '/' && pathname.startsWith(path));
        return (
          <a
            href={path}
            class={`mobile-nav-item w-full text-center py-3 text-eos-accent font-bold uppercase tracking-widest hover:bg-eos-base rounded-xl transition-colors px-4 ${isActive ? 'bg-eos-base' : ''}`}
          >
            {isEn ? item.en : item.de}
          </a>
        );
      })}
    </div>
    <!-- Mobile Actions: Book & User Login -->
    <div class="mt-8 pt-8 border-t border-eos-subtle space-y-4 flex flex-col items-center">
      <!-- Book Button -->
      <a
        href="https://backoffice.bsport.io/c/5082/home/"
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center justify-center w-full px-4 py-3 bg-eos-accent text-white text-sm font-bold uppercase tracking-widest rounded-lg transition-all duration-200 hover:bg-eos-accent/90"
      >
        {isEn ? 'Book' : 'Buchen'}
      </a>

      <!-- User Login -->
      <a
        href="https://backoffice.bsport.io/login?membership=5082"
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center justify-center w-full space-x-2 py-3 text-eos-accent font-bold uppercase tracking-widest hover:bg-eos-base rounded-lg transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span>{isEn ? 'Login' : 'Anmelden'}</span>
      </a>

      <LangSwitch translationSlug={translationSlug} variant="button" />
    </div>
  </nav>

  <!-- Footer Mark -->
  <div class="p-6 border-t border-eos-subtle">
    <p class="text-xs text-eos-contrast/60 uppercase tracking-widest">EOS CLUB</p>
  </div>
</aside>

<script>
  import { gsap } from 'gsap';

  // --- Mobile Menu Logic ---
  const menuButton = document.getElementById('mobile-menu-button');
  const closeButton = document.getElementById('mobile-close-button');
  const sidebar = document.getElementById('mobile-sidebar');
  const overlay = document.getElementById('mobile-overlay');

  let isMenuOpen = false;

  function openMenu() {
    isMenuOpen = true;
    sidebar?.classList.remove('-translate-x-full');
    sidebar?.classList.add('pointer-events-auto');
    overlay?.classList.remove('hidden');
    setTimeout(() => overlay?.classList.add('opacity-100'), 10);
    document.body.style.overflow = 'hidden';
    menuButton?.setAttribute('aria-expanded', 'true');
    closeButton?.focus();
  }

  function closeMenu() {
    isMenuOpen = false;
    sidebar?.classList.add('-translate-x-full');
    sidebar?.classList.remove('pointer-events-auto');
    overlay?.classList.remove('opacity-100');
    setTimeout(() => overlay?.classList.add('hidden'), 300);
    document.body.style.overflow = '';
    menuButton?.setAttribute('aria-expanded', 'false');
    menuButton?.focus();
  }

  menuButton?.addEventListener('click', openMenu);
  closeButton?.addEventListener('click', closeMenu);
  overlay?.addEventListener('click', closeMenu);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isMenuOpen) {
      closeMenu();
    }
  });

  // --- Desktop Nav Underline Animation ---
  function initNavUnderline() {
    const nav = document.getElementById('desktop-nav');
    const underline = document.getElementById('nav-underline');
    const links = document.querySelectorAll('[data-nav-link]');
    const activeLink = document.querySelector('[data-nav-link].is-active') as HTMLElement;

    if (!nav || !underline || window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const setUnderline = (el: HTMLElement, immediate = false) => {
      gsap.to(underline, {
        left: el.offsetLeft,
        width: el.offsetWidth,
        opacity: 1,
        duration: immediate ? 0 : 0.4,
        ease: 'power2.out'
      });
    };

    if (activeLink) {
      setUnderline(activeLink, true);
    }

    links.forEach(link => {
      link.addEventListener('mouseenter', () => setUnderline(link as HTMLElement));
    });

    nav.addEventListener('mouseleave', () => {
      if (activeLink) {
        setUnderline(activeLink);
      } else {
        gsap.to(underline, { opacity: 0, duration: 0.3 });
      }
    });
  }

  // Initialize on load and after swap
  initNavUnderline();
  document.addEventListener('astro:after-swap', initNavUnderline);
</script>
