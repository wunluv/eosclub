---
/**
 * BsportLeadCapture.astro
 *
 * Renders the bsport lead acquisition / contact capture form widget.
 * widgetType: "newsletterV2"
 * dialogMode: 0 = popup trigger (bsport default for this widget type)
 *
 * NOTE: This widget uses dialogMode: 0 (popup), unlike the other bsport widgets
 * which use dialogMode: 3 (inline). Bsport renders a trigger button that opens
 * a modal form. If an inline form is preferred, discuss with bsport support.
 *
 * This may serve as a replacement for the existing EmailSignup.astro component
 * once bsport is the confirmed CRM/contact system for EOS CLUB.
 *
 * Usage:
 *   <BsportLeadCapture />
 *
 * Usage — custom config:
 *   <BsportLeadCapture
 *     fieldsType="firstNameAndEmail"
 *     showSubtitle={true}
 *     showSuccessTitle={false}
 *     showSuccessText={false}
 *   />
 *
 * Props map 1:1 to the bsport newsletterV2 config object.
 * Defaults match the bsport dashboard output.
 *
 * Requires BaseLayout.astro to expose <slot name="head" /> inside its <head> block.
 */

interface Props {
  /**
   * Form fields to display.
   * "fullNameAndEmail"  — first name, last name, email (dashboard default)
   * "firstNameAndEmail" — first name and email only
   * "emailOnly"         — email address only (inferred — verify with bsport)
   */
  fieldsType?: "fullNameAndEmail" | "firstNameAndEmail" | "emailOnly";
  /** Show the form subtitle text. Default: false. */
  showSubtitle?: boolean;
  /** Show the success state title after submission. Default: true. */
  showSuccessTitle?: boolean;
  /** Show the success state body text after submission. Default: true. */
  showSuccessText?: boolean;
}

const {
  fieldsType = "fullNameAndEmail",
  showSubtitle = false,
  showSuccessTitle = true,
  showSuccessText = true,
} = Astro.props;

const WIDGET_ELEMENT_ID = "bsport-widget-101191";
const COMPANY_ID = 5082;
---

<Fragment slot="head">
  <!-- bsport CDN loader: guarded against duplicate inserts -->
  <script id="insert-bsport-widget-cdn" is:inline>
    !function (b, s, p) {
      typeof window.BsportWidget === "undefined" &&
        !document.getElementById("bsport-widget-cdn") &&
        (function () {
          var m = b.createElement(s);
          m.id = "bsport-widget-cdn";
          m.src = p;
          b.getElementsByTagName("head")[0].appendChild(m);
        })();
    }(document, "script", "https://cdn.bsport.io/scripts/widget.js");
  </script>
</Fragment>

<!-- Mount target -->
<div id={WIDGET_ELEMENT_ID} class="bsport-lead-capture-widget"></div>

<style is:global>
  /*
   * Bsport Lead Capture Widget Styling
   * Targets the internal elements of the bsport newsletterV2 widget
   * based on actual rendered HTML structure.
   */

  /* 1. Form Container & Cleanslate Overrides */
  .bsport-lead-capture-widget .cleanslate,
  .bsport-lead-capture-widget .bs-newsletter-form__container,
  .bsport-lead-capture-widget .bs-newsletter-form__root,
  .bsport-lead-capture-widget .jss1,
  .bsport-lead-capture-widget .jss2,
  .bsport-lead-capture-widget div[class*="jss"] {
    background-color: transparent !important;
    background: transparent !important;
    font-family: 'Geist Sans', 'Inter', sans-serif !important;
    box-shadow: none !important;
    border: none !important;
  }

  /* 2. Labels & Typography */
  .bsport-lead-capture-widget .bs-newsletter-form__root__form__field-label,
  .bsport-lead-capture-widget .bs-typography-body-sm,
  .bsport-lead-capture-widget label p,
  .bsport-lead-capture-widget .bs-typography-body-md {
    color: white !important; /* White text for footer contrast */
    font-weight: 700 !important;
    text-transform: uppercase !important;
    font-size: 0.75rem !important;
    letter-spacing: 0.1em !important;
    margin-bottom: 0.5rem !important;
  }

  /* 3. Inputs (Zen Mode) */
  .bsport-lead-capture-widget .bs-fabrique-input-base,
  .bsport-lead-capture-widget .bs-fabrique-textfield__input,
  .bsport-lead-capture-widget input,
  .bsport-lead-capture-widget .bs-fabrique-textfield__input__container,
  .bsport-lead-capture-widget .bs-fabrique-textfield__input__text {
    background-color: #09090B !important; /* eos-zen */
    color: white !important;
    border: 1px solid #E6E5E0 !important; /* eos-subtle */
    border-radius: 0.75rem !important;
    font-family: 'Geist Sans', 'Inter', sans-serif !important;
    width: 100% !important;
  }

  .bsport-lead-capture-widget input {
    padding: 0.75rem 1rem !important;
    background-color: #09090B !important;
    color: white !important;
  }

  .bsport-lead-capture-widget .bs-fabrique-input-base:focus,
  .bsport-lead-capture-widget input:focus {
    outline: none !important;
    border-color: #FF2E00 !important; /* eos-accent */
    box-shadow: 0 0 0 2px rgba(255, 46, 0, 0.2) !important;
  }

  /* 4. Submit Button */
  .bsport-lead-capture-widget .bs-newsletter-form__root__form__submit,
  .bsport-lead-capture-widget button[type="submit"] {
    background-color: #FF2E00 !important; /* eos-accent */
    color: white !important;
    font-family: 'Geist Sans', 'Inter', sans-serif !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.1em !important;
    border-radius: 0.5rem !important;
    padding: 0.75rem 1.5rem !important;
    transition: all 0.2s ease !important;
    border: none !important;
    width: 100% !important;
    margin-top: 1rem !important;
    cursor: pointer !important;
  }

  .bsport-lead-capture-widget .bs-newsletter-form__root__form__submit:hover {
    opacity: 0.9 !important;
    transform: translateY(-1px) !important;
  }

  /* 5. Remove Bsport Branding */
  .bsport-lead-capture-widget .jss17, /* Logo container */
  .bsport-lead-capture-widget .jss18,
  .bsport-lead-capture-widget .jss19,
  .bsport-lead-capture-widget .jss20,
  .bsport-lead-capture-widget [class*="MuiTypography-caption"],
  .bsport-lead-capture-widget img[src*="bsport_logo"],
  .bsport-lead-capture-widget img[src*="bsport"],
  .bsport-lead-capture-widget .MuiTypography-colorTextSecondary,
  .bsport-lead-capture-widget div[class*="jss"][style*="position: absolute; bottom: 0"] {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
  }
</style>
</style>
</style>

<!-- Mount script -->
<script
  is:inline
  define:vars={{ WIDGET_ELEMENT_ID, COMPANY_ID, fieldsType, showSubtitle, showSuccessTitle, showSuccessText }}
>
  function mountBsportLeadCapture(config, repeat) {
    repeat = repeat || 1;
    if (repeat > 50) return;
    if (!window.BsportWidget) {
      return setTimeout(function () {
        mountBsportLeadCapture(config, repeat + 1);
      }, 100 * repeat || 1);
    }
    BsportWidget.mount(config);
  }

  mountBsportLeadCapture({
    parentElement: WIDGET_ELEMENT_ID,
    companyId: COMPANY_ID,
    franchiseId: null,
    dialogMode: 0,
    widgetType: "newsletterV2",
    showFab: false,
    fullScreenPopup: false,
    styles: undefined,
    config: {
      newsletterV2: {
        fieldsType: fieldsType,
        showSubtitle: showSubtitle,
        showSuccessTitle: showSuccessTitle,
        showSuccessText: showSuccessText
      }
    }
  });
</script>
