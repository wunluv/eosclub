---
/**
 * BsportWorkshop.astro
 *
 * Renders the bsport workshops / events listing widget.
 * dialogMode: 3 = inline / no popup ("No Popup beta")
 * widgetType: "workshop"
 *
 * Usage — bare (show all workshops):
 *   <BsportWorkshop />
 *
 * Usage — filtered:
 *   <BsportWorkshop
 *     coaches={[42]}
 *     establishments={[7]}
 *     metaActivities={[101]}
 *     levels={[1]}
 *   />
 *
 * Props map 1:1 to the bsport workshop config object.
 * All props are optional; defaults match the bsport dashboard "No Popup" output.
 *
 * Requires BaseLayout.astro to expose <slot name="head" /> inside its <head> block.
 */

interface Props {
  /** Array of coach IDs to filter by. */
  coaches?: number[];
  /** Array of establishment/location IDs to filter by. */
  establishments?: number[];
  /** Array of meta-activity IDs to filter by. */
  metaActivities?: number[];
  /** Array of level IDs to filter by. */
  levels?: number[];
}

const {
  coaches = [],
  establishments = [],
  metaActivities = [],
  levels = [],
} = Astro.props;

const WIDGET_ELEMENT_ID = "bsport-widget-767203";
const COMPANY_ID = 5082;
---

<Fragment slot="head">
  <!-- bsport CDN loader: guarded against duplicate inserts -->
  <script id="insert-bsport-widget-cdn" is:inline>
    !function (b, s, p) {
      typeof window.BsportWidget === "undefined" &&
        !document.getElementById("bsport-widget-cdn") &&
        (function () {
          var m = b.createElement(s);
          m.id = "bsport-widget-cdn";
          m.src = p;
          b.getElementsByTagName("head")[0].appendChild(m);
        })();
    }(document, "script", "https://cdn.bsport.io/scripts/widget.js");
  </script>
</Fragment>

<!-- Mount target -->
<div id={WIDGET_ELEMENT_ID} class="bsport-workshop-widget"></div>

<!-- Mount script -->
<script
  is:inline
  define:vars={{ WIDGET_ELEMENT_ID, COMPANY_ID, coaches, establishments, metaActivities, levels }}
>
  function mountBsportWorkshop(config, repeat) {
    repeat = repeat || 1;
    if (repeat > 50) return;
    if (!window.BsportWidget) {
      return setTimeout(function () {
        mountBsportWorkshop(config, repeat + 1);
      }, 100 * repeat || 1);
    }
    BsportWidget.mount(config);
  }

  mountBsportWorkshop({
    parentElement: WIDGET_ELEMENT_ID,
    companyId: COMPANY_ID,
    franchiseId: null,
    dialogMode: 3,
    widgetType: "workshop",
    showFab: false,
    fullScreenPopup: false,
    styles: undefined,
    config: {
      workshop: {
        coaches: coaches,
        establishments: establishments,
        metaActivities: metaActivities,
        levels: levels
      }
    }
  });
</script>
